<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>PDFæŠ½å‡ºãƒ†ã‚¹ãƒˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
</head>
<body>
    <h1>PDFæŠ½å‡ºãƒ†ã‚¹ãƒˆ</h1>
    <input type="file" id="pdfFile" accept=".pdf">
    <div id="results" style="font-family: monospace; white-space: pre-wrap; margin-top: 20px;"></div>
    
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        document.getElementById('pdfFile').addEventListener('change', async function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.textContent = 'PDFè§£æä¸­...';
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                
                let allText = '';
                
                // 1ãƒšãƒ¼ã‚¸ç›®ã¯ã‚¹ã‚­ãƒƒãƒ—
                for (let pageNum = 2; pageNum <= pdf.numPages; pageNum++) {
                    const page = await pdf.getPage(pageNum);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    allText += pageText + '\n';
                }
                
                // ä¿®æ­£ç‰ˆã®æŠ½å‡ºãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½¿ç”¨
                const data = extractRealSalonBoardData(allText);
                
                let result = `PDFå…¨æ–‡é•·: ${allText.length}\n`;
                result += `æŠ½å‡ºã•ã‚ŒãŸãƒ¬ã‚³ãƒ¼ãƒ‰æ•°: ${data.length}\n\n`;
                
                data.forEach((record, i) => {
                    result += `=== ãƒ¬ã‚³ãƒ¼ãƒ‰ ${i + 1} ===\n`;
                    result += `æ—¥ä»˜: ${record.date}\n`;
                    result += `æ™‚é–“: ${record.time}\n`;
                    result += `æ‹…å½“è€…: ${record.staffName}\n`;
                    result += `ç¾è¨ˆ: ${record.totalAmount}å††\n`;
                    result += `ãƒã‚¤ãƒ³ãƒˆ: ${record.pointUsage}å††\n\n`;
                });
                
                resultsDiv.textContent = result;
                
            } catch (error) {
                resultsDiv.textContent = `ã‚¨ãƒ©ãƒ¼: ${error.message}`;
            }
        });
        
        // ä¿®æ­£ç‰ˆã®PDFæŠ½å‡ºé–¢æ•°
        function extractRealSalonBoardData(text) {
            const data = [];
            console.log('ğŸ” å®Ÿéš›ã®ã‚µãƒ­ãƒ³ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºä¸­...');
            
            // ã€Œé©æ ¼è«‹æ±‚æ›¸ç™ºè¡Œäº‹æ¥­è€…ã€ã§å–å¼•ã‚’åˆ†å‰²
            const transactions = text.split('é©æ ¼è«‹æ±‚æ›¸ç™ºè¡Œäº‹æ¥­è€…').filter(t => t.trim().length > 0);
            
            console.log(`ğŸ“ ã€Œé©æ ¼è«‹æ±‚æ›¸ç™ºè¡Œäº‹æ¥­è€…ã€ã§åˆ†å‰²: ${transactions.length}å€‹`);
            
            for (let i = 0; i < transactions.length; i++) {
                const transaction = transactions[i];
                console.log(`\nğŸ” å–å¼• ${i + 1}: é•·ã•=${transaction.length}`);
                console.log(`  å†…å®¹: ${transaction.substring(0, 200)}...`);
                
                try {
                    // æ—¥æ™‚æŠ½å‡º
                    const dateTimeMatch = transaction.match(/(\d{4}\/\d{1,2}\/\d{1,2})\s+(\d{1,2}:\d{2})/);
                    if (!dateTimeMatch) {
                        console.log('  âŒ æ—¥æ™‚ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                        continue;
                    }
                    
                    const date = dateTimeMatch[1];
                    const time = dateTimeMatch[2];
                    console.log(`  ğŸ“… æ—¥æ™‚: ${date} ${time}`);
                    
                    // æ‹…å½“è€…æŠ½å‡ºï¼ˆã‚¹ãƒšãƒ¼ã‚¹ã‚’è€ƒæ…®ï¼‰
                    const staffMatch = transaction.match(/æ‹…å½“ã‚¹ã‚¿ã‚¤ãƒªã‚¹ãƒˆ\s+([^\s]+(?:\s+[^\s]+)*?)\s+ãƒ¬ã‚¸/);
                    let staffName = staffMatch ? staffMatch[1].replace(/\s+/g, '') : '';
                    
                    // ç‰¹æ®Šæ–‡å­—æ­£è¦åŒ–
                    staffName = staffName.replace(/â½¥/g, 'ç”°').replace(/â¼ /g, 'å£«');
                    console.log(`  ğŸ‘¤ æ‹…å½“è€…: "${staffName}"`);
                    
                    // ç¾è¨ˆæŠ½å‡º
                    const totalMatch = transaction.match(/ç¾è¨ˆ\s+([\d,]+)\s*å††/);
                    if (!totalMatch) {
                        console.log('  âŒ ç¾è¨ˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                        continue;
                    }
                    const totalAmount = parseInt(totalMatch[1].replace(/,/g, ''));
                    console.log(`  ğŸ’° ç¾è¨ˆ: ${totalAmount}å††`);
                    
                    // ãƒã‚¤ãƒ³ãƒˆæŠ½å‡º
                    const pointMatch = transaction.match(/ãƒã‚¤ãƒ³ãƒˆåˆ©[â½¤ç”¨]é¡\s+([\d,]+)\s*å††/);
                    const pointUsage = pointMatch ? parseInt(pointMatch[1].replace(/,/g, '')) : 0;
                    console.log(`  ğŸ¯ ãƒã‚¤ãƒ³ãƒˆ: ${pointUsage}å††`);
                    
                    // ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
                    const record = {
                        date: date,
                        time: time,
                        totalAmount: totalAmount,
                        pointUsage: pointUsage,
                        staffName: staffName,
                        source: 'SalonBoard',
                        originalLine: transaction.substring(0, 100) + '...'
                    };
                    
                    data.push(record);
                    console.log(`  âœ… æŠ½å‡ºæˆåŠŸ:`, record);
                    
                } catch (error) {
                    console.error(`  âŒ å–å¼• ${i + 1} å‡¦ç†ã‚¨ãƒ©ãƒ¼:`, error);
                }
            }
            
            console.log(`ğŸ¯ æœ€çµ‚æŠ½å‡ºçµæœ: ${data.length}ä»¶`);
            return data;
        }
    </script>
</body>
</html>